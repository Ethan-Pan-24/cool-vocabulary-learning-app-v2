{% extends "layout.html" %}
{% block content %}
<div class="mb-4">
    <a href="/admin" class="btn btn-outline-secondary mb-3">&larr; Back to Dashboard</a>
    <div class="d-flex justify-content-between align-items-center">
        <h1>Manage Content: {{ course.name }}</h1>
        <div>
            <a href="/admin/course/{{ course.id }}/content_manager" class="btn btn-primary me-2">
                <i class="bi bi-grid-3x3-gap-fill"></i> Open Content Manager
            </a>
            <button class="btn btn-outline-warning me-2" type="button" data-bs-toggle="collapse"
                data-bs-target="#editCourseForm">
                Edit Settings
            </button>
            <button class="btn btn-outline-info me-2" type="button" data-bs-toggle="collapse"
                data-bs-target="#editStagesForm">
                Edit Stages
            </button>

            <form action="/admin_api/clone_course/{{ course.id }}" method="post" style="display:inline;"
                onsubmit="return confirm('Clone this entire course?');">
                <button class="btn btn-outline-secondary" title="Clone Course"><i class="bi bi-copy"></i></button>
            </form>
        </div>
    </div>

    <!-- 1. Edit Course Settings Form -->
    <div class="collapse mb-4 mt-3" id="editCourseForm">
        <div class="card card-body bg-light border-warning">
            <h5>Edit Course Settings</h5>
            <form action="/admin_api/update_course/{{ course.id }}" method="post">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Course Name</label>
                        <input type="text" name="name" class="form-control" value="{{ course.name }}" required>
                    </div>
                    <div class="col-md-5 mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" name="description" class="form-control" value="{{ course.description }}">
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Groups</label>
                        <input type="text" name="groups" class="form-control" value="{{ course.group_names }}">
                    </div>
                    <div class="col-md-1 mb-3">
                        <label class="form-label" title="Minutes, 0=unlimited">Quiz Time</label>
                        <input type="number" name="quiz_time_limit" class="form-control px-2"
                            value="{{ course.quiz_time_limit or 5 }}" min="0">
                    </div>
                </div>
                <button type="submit" class="btn btn-warning">Update Course</button>
            </form>

            <hr>

            <h6 class="text-danger mt-3">Danger Zone</h6>
            <form action="/admin_api/reset_course_data/{{ course.id }}" method="post"
                onsubmit="return confirm('WARNING: This will delete ALL user enrollments, progress, and quiz results for THIS course ({{ course.name }}). This cannot be undone. Are you sure?');">
                <button type="submit" class="btn btn-outline-danger btn-sm">
                    Reset User Data for This Course
                </button>
            </form>
        </div>
    </div>

    <!-- 2. Edit Stages Form -->
    <div class="collapse mb-4 mt-3" id="editStagesForm">
        <div class="card card-body bg-light border-info">
            <h5>Learning Stages Configuration</h5>
            <p class="text-muted small">Define learning stages. Sequential.</p>

            <form id="stageConfigForm" action="/admin_api/update_course_stages/{{ course.id }}" method="post">
                <input type="hidden" name="stage_config" id="stageConfigInput">

                <div id="stagesContainer">
                    <!-- JS will populate this -->
                </div>

                <div class="mt-3">
                    <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="addStageRow()">+ Add
                        Stage</button>
                </div>

                <div class="d-flex justify-content-between align-items-center border-top pt-3">
                    <span id="totalCountDisplay" class="fw-bold text-muted">Total Words Covered: 0</span>
                    <button type="submit" class="btn btn-info text-white" onclick="prepareStageConfig()">Save
                        Stages</button>
                </div>
            </form>
        </div>
    </div>

    <p class="text-muted text-center mt-2">{{ course.description }}</p>
</div>

<div class="row">
    <!-- 3. Hint for Content Manager -->
    <div class="row">
        <div class="col-md-12">
            <div class="alert alert-info shadow-sm">
                <i class="bi bi-info-circle-fill me-2"></i>
                To manage vocabulary words, assignments, and order, please use the
                <a href="/admin/course/{{ course.id }}/content_manager" class="fw-bold text-decoration-none">Content
                    Manager</a>.
            </div>
        </div>
    </div>
</div>

<script>
    // --- PART A: Stage Manager Logic ---
    let currentStages = {{ stage_list | tojson | safe }};
    // Ensure it's an array
    if (!Array.isArray(currentStages)) currentStages = [];

    const stagesContainer = document.getElementById('stagesContainer');
    const totalCountDisplay = document.getElementById('totalCountDisplay');
    const vocabCount = {{ vocab_list | length }};

    function renderStages() {
        if (!stagesContainer) return;
        stagesContainer.innerHTML = '';
        let runningTotal = 0;

        currentStages.forEach((stage, index) => {
            const count = parseInt(stage.count) || 0;
            runningTotal += count;

            const row = document.createElement('div');
            row.className = 'row mb-2 align-items-center bg-white p-2 border rounded';
            row.innerHTML = `
            <div class="col-md-1 text-center fw-bold text-muted">${index + 1}</div>
            <div class="col-md-9">
                <input type="text" class="form-control form-control-sm" placeholder="Stage Name" 
                    value="${stage.name || ''}" onchange="updateStage(${index}, 'name', this.value)">
            </div>
            <div class="col-md-2 text-end">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeStage(${index})">&times;</button>
            </div>
        `;
            stagesContainer.appendChild(row);
        });
    }

    function addStageRow() {
        currentStages.push({ name: `Stage ${currentStages.length + 1}` });
        renderStages();
    }

    function removeStage(index) {
        currentStages.splice(index, 1);
        renderStages();
    }

    function updateStage(index, field, value) {
        currentStages[index][field] = value;
        renderStages();
    }

    function prepareStageConfig() {
        // Just save names
        document.getElementById('stageConfigInput').value = JSON.stringify(currentStages);
    }

    // --- PART B: Vocab Edit Logic ---
    const vocabDataMap = {};
    try {
        const rawData = {{ vocab_data | tojson | safe
    }};
    rawData.forEach(v => vocabDataMap[v.id] = v);
    console.log("Loaded " + rawData.length + " items.");
    } catch (e) {
        console.error("Data Load Error", e);
    }

    window.editVocabWrapper = function (id) {
        const d = vocabDataMap[id];
        if (!d) return alert("Error: Missing data for ID " + id);
        editVocab(d);
    };

    function editVocab(d) {
        const formEl = document.getElementById('vocabForm');
        // Reset if previously in edit mode
        if (formEl.action.includes("update_vocab")) {
            resetForm(formEl);
        }

        formEl.action = `/admin_api/update_vocab/${d.id}`;

        const btn = formEl.querySelector('button[type="submit"]');
        btn.textContent = "Update Vocabulary (Order: " + d.order + ")";
        btn.classList.replace('btn-primary', 'btn-warning');

        // Fill fields
        if (formEl.querySelector('[name="word"]')) formEl.querySelector('[name="word"]').value = d.word;
        if (formEl.querySelector('[name="chinese"]')) formEl.querySelector('[name="chinese"]').value = d.chinese;
        if (formEl.querySelector('[name="story"]')) formEl.querySelector('[name="story"]').value = d.story;
        if (formEl.querySelector('[name="group"]')) formEl.querySelector('[name="group"]').value = d.group;
        if (formEl.querySelector('[name="image"]')) formEl.querySelector('[name="image"]').value = d.image || "";
        if (formEl.querySelector('[name="display_order"]')) formEl.querySelector('[name="display_order"]').value = d.order || 0;

        // Cancel Button
        if (!document.getElementById('cancelEditBtn')) {
            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.id = 'cancelEditBtn';
            cancelBtn.className = 'btn btn-secondary w-100 mt-2';
            cancelBtn.textContent = 'Cancel Edit';
            cancelBtn.onclick = () => resetForm(formEl);
            formEl.appendChild(cancelBtn);
        }

        // Scroll to form (top of Add Word section)
        formEl.scrollIntoView({ behavior: 'smooth' });
    }

    function resetForm(form) {
        form.action = "/admin_api/add_word";
        form.reset();
        const btn = form.querySelector('button[type="submit"]');
        btn.textContent = "Add Vocabulary";
        btn.classList.replace('btn-warning', 'btn-primary');
        form.querySelector('[name="group"]').value = "Common";

        const cancel = document.getElementById('cancelEditBtn');
        if (cancel) cancel.remove();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        renderStages();
    });
</script>
{% endblock %}