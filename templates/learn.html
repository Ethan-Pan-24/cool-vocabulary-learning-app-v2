{% extends "layout.html" %}

{% block content %}
<style>
    .image-container {
        position: relative;
        display: inline-block;
        width: 100%;
        height: 100%;
    }

    .highlighted-word {
        color: #0066cc;
        font-weight: bold;
        text-decoration: underline;
    }
</style>
<div class="container" style="max-width: 800px;">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 sticky-top bg-white py-3 border-bottom"
        style="z-index: 10;">
        <div>
            <h3 class="mb-0">Learning: {{ current_stage_name }}</h3>
            <small class="text-muted">{{ vocab_list|length }} Words in this stage</small>
        </div>
        <div>
            {% if is_completed %}
            <span class="badge bg-success me-2">Course Completed</span>
            {% endif %}
            {% if is_admin %}
            <div class="d-inline-block">
                <select class="form-select form-select-sm py-0 px-2" style="height: auto;"
                    onchange="const url = new URL(window.location); url.searchParams.set('preview_group', this.value); window.location.href = url.toString();">
                    {% for g in all_groups %}
                    <option value="{{ g }}" {% if group==g %}selected{% endif %}>Group {{ g }}</option>
                    {% endfor %}
                </select>
            </div>
            {% else %}
            <span class="badge bg-secondary">Group: {{ group }}</span>
            {% endif %}
            <span id="timerDisplay" class="badge bg-light text-dark border ms-2" style="display: none;">00:00</span>
        </div>
    </div>

    {% if is_completed %}
    <div class="alert alert-success d-flex justify-content-between align-items-center">
        <div>
            <i class="bi bi-check-circle-fill me-2"></i>
            You have already completed the quiz. You can review the content.
        </div>
        <a href="/courses" class="btn btn-sm btn-outline-success">Back to Course List</a>
    </div>
    {% endif %}

    <!-- Vertical Word List -->
    <div id="wordListContainer" class="mb-5">
        {% for item in vocab_list %}
        <div class="card shadow mb-5 word-card">
            <!-- Top Section: Word & Audio -->
            <div class="card-header bg-transparent border-bottom-0 pt-4 pb-0 text-center">
                <h1 class="display-4 fw-bold text-primary mb-1">{{ item.word }}</h1>
                <h3 class="text-secondary mb-3">{{ item.chinese_meaning }}</h3>

                {% if item.audio_url %}
                <div class="mx-auto mb-3" style="max-width: 200px;">
                    <audio controls class="w-100" style="height: 30px;">
                        <source src="{{ item.audio_url }}" type="audio/mpeg">
                    </audio>
                </div>
                {% endif %}
            </div>

            <div class="card-body p-0">
                <div class="row g-0">
                    {% if item.image_url %}
                    <!-- Image Left -->
                    <div class="col-md-6 bg-light d-flex align-items-center justify-content-center p-3">
                        <div class="image-container">
                            <img src="{{ item.image_url }}" class="img-fluid rounded" alt="{{ item.word }}"
                                style="max-height: 250px; width: auto; object-fit: contain;"
                                onload="trackImageView('{{ item.image_url }}', {{ course_id }}, {{ item.id }})">
                        </div>
                    </div>
                    <!-- Story Right -->
                    <div class="col-md-6 d-flex align-items-center">
                        <div class="p-4">
                            <i class="bi bi-quote text-muted fs-4"></i>
                            <p class="fst-italic text-dark mb-0 lead story-text" data-word="{{ item.word }}"
                                style="line-height: 1.6;">
                                {{ item.story }}
                            </p>
                        </div>
                    </div>
                    {% else %}
                    <!-- No Image: Full Width Story -->
                    <div class="col-12 text-center p-5">
                        <i class="bi bi-book text-muted fs-2 mb-3"></i>
                        <p class="fst-italic text-dark mb-0 display-6 story-text" data-word="{{ item.word }}"
                            style="font-size: 1.5rem; line-height: 1.8;">
                            "{{ item.story }}"
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Navigation Footer -->
    <div class="d-grid gap-2 mb-5 pb-5">
        {% if not is_last_stage %}
        <button class="btn btn-primary btn-lg p-3"
            onclick="saveAndProceed('/learn/{{ course_id }}?stage_index={{ next_stage_index }}{% if preview_group %}&preview_group={{ preview_group }}{% endif %}')">
            Proceed to Next Stage <i class="bi bi-arrow-right"></i>
        </button>
        {% else %}

        {% if is_completed %}
        <div class="alert alert-success">
            <h4 class="alert-heading">Congratulations! You have completed the quiz for this unit.</h4>
            <p>You can view your detailed analysis report or retake the quiz.</p>
            <hr>
            <div class="d-flex gap-2 justify-content-center">
                <a href="javascript:void(0)"
                    onclick="saveAndProceed('/quiz/{{ course_id }}{% if preview_group %}?preview_group={{ preview_group }}{% endif %}')"
                    class="btn btn-primary">Retake Quiz (Attempt {{ attempt_count + 1 }})</a>
                <a href="/student_results/{{ course_id }}{% if preview_group %}?preview_group={{ preview_group }}{% endif %}"
                    class="btn btn-info text-white">View Analytics Report</a>
            </div>
        </div>
        <a href="/courses" class="btn btn-outline-secondary btn-lg">Back to Courses</a>
        {% else %}
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> You have reached the final stage!
        </div>
        <button class="btn btn-success btn-lg p-3"
            onclick="saveAndProceed('/quiz/{{ course_id }}{% if preview_group %}?preview_group={{ preview_group }}{% endif %}')">
            Take Quiz <i class="bi bi-check-lg"></i>
        </button>
        {% endif %}

        {% endif %}
    </div>

</div>

<script>
    const courseId = {{ course_id }};
    const stageName = "{{ current_stage_name }}";
    // Key for PER-STAGE timing: { "Stage 1": 120, "Stage 2": ... }
    const stageStorageKey = `stage_times_${courseId}`;
    // Key for TOTAL timing (legacy/redundant but good for backup): 1234.5
    const totalStorageKey = `learning_time_${courseId}`;

    let sessionSeconds = 0;

    // Timer Tick
    setInterval(() => {
        if (document.visibilityState === 'visible') {
            sessionSeconds++;
            updateTimerDisplay();
        }
    }, 1000);

    function updateTimerDisplay() {
        const mins = Math.floor(sessionSeconds / 60).toString().padStart(2, '0');
        const secs = (sessionSeconds % 60).toString().padStart(2, '0');
        const el = document.getElementById('timerDisplay');
        if (el) el.innerText = `${mins}:${secs}`;
    }

    window.saveAndProceed = function (url) {
        // 1. Update Stage Time Map
        let stageData = {};
        try {
            stageData = JSON.parse(localStorage.getItem(stageStorageKey) || "{}");
        } catch (e) { stageData = {}; }

        stageData[stageName] = (stageData[stageName] || 0) + sessionSeconds;
        localStorage.setItem(stageStorageKey, JSON.stringify(stageData));

        // 2. Update Total Time
        let totalTime = parseFloat(localStorage.getItem(totalStorageKey)) || 0;
        localStorage.setItem(totalStorageKey, totalTime + sessionSeconds);

        // 3. Navigate
        window.location.href = url;
    };


    function trackImageView(imageUrl, courseId, vocabId) {
        const formData = new FormData();
        formData.append('image_url', imageUrl);
        formData.append('action', 'view');
        formData.append('course_id', courseId);
        formData.append('vocab_id', vocabId || '');
        formData.append('context', 'learning');

        fetch('/api/image_interaction', { method: 'POST', body: formData }).catch(e => console.error('View tracking failed', e));
    }

    // Highlight target word in story text
    function highlightWordsInStory() {
        document.querySelectorAll('.story-text').forEach(paragraph => {
            const targetWord = paragraph.getAttribute('data-word');
            if (!targetWord) return;

            let text = paragraph.innerHTML;
            // Create case-insensitive regex to match whole words
            const regex = new RegExp(`\\b(${targetWord})\\b`, 'gi');
            text = text.replace(regex, '<span class="highlighted-word">$1</span>');
            paragraph.innerHTML = text;
        });
    }

    // Run on page load
    document.addEventListener('DOMContentLoaded', highlightWordsInStory);

</script>
{% endblock %}