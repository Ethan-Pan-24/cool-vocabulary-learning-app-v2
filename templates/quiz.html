{% extends "layout.html" %}
{% block content %}
<style>
    .image-container {
        position: relative;
        display: inline-block;
    }

    /* Grading Overlay */
    #gradingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        display: none;
        /* Hidden by default */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .grading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .grading-text {
        font-size: 1.5rem;
        font-weight: 300;
        letter-spacing: 1px;
    }
</style>

<!-- Full Screen Grading Overlay -->
<div id="gradingOverlay">
    <div class="grading-spinner"></div>
    <div id="gradingStatus" class="grading-text">Submitting Quiz...</div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <h1>Quiz Phase</h1>
        {% if is_admin %}
        <div class="ms-3">
            <select class="form-select"
                onchange="const url = new URL(window.location); url.searchParams.set('preview_group', this.value); window.location.href = url.toString();">
                {% for g in all_groups %}
                <option value="{{ g }}" {% if group==g or (not group and preview_group==g) %}selected{% endif %}>Group
                    {{ g }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </div>
    <div class="timer" id="timer" {% if quiz_time_limit==0 %}style="display:none;" {% endif %}>05:00</div>
</div>

<form action="/submit_quiz/{{ course_id }}{% if preview_group %}?preview_group={{ preview_group }}{% endif %}"
    method="post" id="quiz-form">
    <input type="hidden" name="learning_duration" id="learning_duration" value="0">
    <input type="hidden" name="stage_timing_json" id="stageTimingInput" value="{}">
    <!-- DYNAMIC QUIZ CONTAINER -->
    <div id="dynamicQuiz" style="display:none;"></div>

    <!-- LEGACY QUIZ FALLBACK -->
    <div id="legacyQuiz">
        <div class="card p-4 mb-4 shadow-sm">
            <h4 class="mb-4">Part 1: English to Chinese</h4>
            {% for item in vocab_list %}
            <div class="mb-4">
                <p class="fw-bold">{{ loop.index }}. What is the Chinese meaning of "{{ item.word }}"?</p>
                {% for option in item.options %}
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="translation_{{ item.id }}" value="{{ option }}"
                        required>
                    <label class="form-check-label">{{ option }}</label>
                </div>
                {% endfor %}
                <div class="form-check text-muted">
                    <input class="form-check-input" type="radio" name="translation_{{ item.id }}" value="I don't know"
                        required>
                    <label class="form-check-label">我不知道 (I don't know)</label>
                </div>
            </div>
            <hr>
            {% endfor %}
        </div>

        <div class="card p-4 mb-4 shadow-sm">
            <h4 class="mb-4">Part 2: Sentence Construction</h4>
            {% for item in vocab_list %}
            <div class="mb-4">
                <p class="fw-bold">{{ loop.index }}. Please write a sentence using the word "<strong>{{ item.word
                        }}</strong>".</p>
                {% if item.image_url %}
                <div class="image-container d-inline-block">
                    <img src="{{ item.image_url }}" class="img-fluid rounded mb-2" style="max-height: 150px;"
                        onload="trackImageView('{{ item.image_url }}', {{ course_id }}, {{ item.id }})">
                </div>
                {% endif %}
                <textarea name="sentence_{{ item.id }}" class="form-control" rows="2"
                    placeholder="Input your sentence here..." required></textarea>
            </div>
            <hr>
            {% endfor %}
        </div>
    </div>

    <div class="card p-4 mb-5 shadow-sm">
        <h4 class="mb-4">NASA-TLX Workload Assessment (工作負荷評量)</h4>
        <p class="text-muted">請根據以下定義，評估您在本次任務中的感受 (0-100)。</p>

        <div class="row">
            <!-- Modified Mental Demand -->
            <div class="col-md-6 mb-4">
                <label class="form-label fw-bold">1. 心智需求 (Mental Demand)</label>
                <div class="small text-muted mb-2">
                    定義：指執行任務時需要多少心理與感知活動（例如：思考、決定、計算、記憶、看、搜尋等）。<br>
                    <strong>評量重點：任務是簡單還是具有挑戰性？是單純還是複雜？是需要精確判斷還是容錯率高？</strong>
                </div>
                <div class="d-flex align-items-center">
                    <span class="me-2 text-muted small">低</span>
                    <input type="range" class="form-range flex-grow-1" name="nasa_mental" min="0" max="100" step="5"
                        value="50" oninput="this.nextElementSibling.innerText = this.value">
                    <div class="ms-2 fw-bold" style="width: 30px; text-align: center;">50</div>
                    <span class="ms-2 text-muted small">高</span>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <label class="form-label fw-bold">2. 體力需求 (Physical Demand)</label>
                <div class="small text-muted mb-2">
                    定義：指執行任務時需要多少肢體活動（例如：推、拉、轉動、控制、啟動等）。<br>
                    <strong>評量重點：任務是輕鬆還是辛苦？步調是緩慢還是快速？是輕鬆舒緩的還是費力勞累的？</strong>
                </div>
                <div class="d-flex align-items-center">
                    <span class="me-2 text-muted small">低</span>
                    <input type="range" class="form-range flex-grow-1" name="nasa_physical" min="0" max="100" step="5"
                        value="50" oninput="this.nextElementSibling.innerText = this.value">
                    <div class="ms-2 fw-bold" style="width: 30px; text-align: center;">50</div>
                    <span class="ms-2 text-muted small">高</span>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <label class="form-label fw-bold">3. 時間需求 (Temporal Demand)</label>
                <div class="small text-muted mb-2">
                    定義：指因為任務發生的頻率或步調，而讓操作者感受到的時間壓力。<br>
                    <strong>評量重點：任務的步調是緩慢閒適的，還是快速且令人瘋狂（急速）的？</strong>
                </div>
                <div class="d-flex align-items-center">
                    <span class="me-2 text-muted small">低</span>
                    <input type="range" class="form-range flex-grow-1" name="nasa_temporal" min="0" max="100" step="5"
                        value="50" oninput="this.nextElementSibling.innerText = this.value">
                    <div class="ms-2 fw-bold" style="width: 30px; text-align: center;">50</div>
                    <span class="ms-2 text-muted small">高</span>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <label class="form-label fw-bold">4. 表現感受 (Performance)</label>
                <div class="small text-muted mb-2">
                    定義：操作者對自己達成任務目標成功程度的自我評估。<br>
                    <strong>評量重點：你認為自己達成實驗(或自己)設定目標的成功率如何？你對自己的表現滿意嗎？</strong>
                </div>
                <div class="d-flex align-items-center">
                    <span class="me-2 text-muted small">低</span>
                    <input type="range" class="form-range flex-grow-1" name="nasa_performance" min="0" max="100"
                        step="5" value="50" oninput="this.nextElementSibling.innerText = this.value">
                    <div class="ms-2 fw-bold" style="width: 30px; text-align: center;">50</div>
                    <span class="ms-2 text-muted small">高</span>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <label class="form-label fw-bold">5. 努力程度 (Effort)</label>
                <div class="small text-muted mb-2">
                    定義：為了達到目前的表現水準，操作者必須投入多少心智與體力上的努力。<br>
                    <strong>評量重點：無論最終結果如何，你為了完成這項任務感覺自己「工作得多辛苦」？</strong>
                </div>
                <div class="d-flex align-items-center">
                    <span class="me-2 text-muted small">低</span>
                    <input type="range" class="form-range flex-grow-1" name="nasa_effort" min="0" max="100" step="5"
                        value="50" oninput="this.nextElementSibling.innerText = this.value">
                    <div class="ms-2 fw-bold" style="width: 30px; text-align: center;">50</div>
                    <span class="ms-2 text-muted small">高</span>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <label class="form-label fw-bold">6. 挫折程度 (Frustration Level)</label>
                <div class="small text-muted mb-2">
                    定義：指在執行任務的過程中，操作者心理感受到的壓力和情緒狀態。<br>
                    <strong>評量重點：你在任務中感到的是安全、滿足、放鬆，還是覺得不安、氣餒、惱火、壓力大且煩躁？</strong>
                </div>
                <div class="d-flex align-items-center">
                    <span class="me-2 text-muted small">低</span>
                    <input type="range" class="form-range flex-grow-1" name="nasa_frustration" min="0" max="100"
                        step="5" value="50" oninput="this.nextElementSibling.innerText = this.value">
                    <div class="ms-2 fw-bold" style="width: 30px; text-align: center;">50</div>
                    <span class="ms-2 text-muted small">高</span>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center mb-5">
        <button type="submit" class="btn btn-danger btn-lg px-5">Submit Quiz</button>
    </div>
</form>

<script>
    // Calculate Learning Duration
    const storageKey = 'learning_time_{{ course_id }}';
    const accumulatedTime = parseFloat(localStorage.getItem(storageKey)) || 0;

    // Stage Timings
    const stageStorageKey = 'stage_times_{{ course_id }}';
    const stageData = localStorage.getItem(stageStorageKey) || "{}";

    // Set to hidden inputs
    document.getElementById('learning_duration').value = accumulatedTime;
    document.getElementById('stageTimingInput').value = stageData;

    // Optional: Clear after submission? 
    // Maybe keep it until explicitly cleared or just leave it. 
    // For now, let's leave it so if they go back they don't lose progress, 
    // but we might want to reset if they start a new session? 
    // Let's assume manual reset isn't needed for this simple flow.

    // Global timer variable (Accumulated valid time)
    window.quizElapsedSeconds = 0;

    // Robust Tracking Variables
    let startTime = Date.now();
    let isVisible = true;

    // Visibility Change Handler
    document.addEventListener("visibilitychange", function () {
        if (document.visibilityState === 'visible') {
            isVisible = true;
            startTime = Date.now(); // Resume tracking
            console.log("Quiz Resumed. Start:", startTime);
        } else {
            isVisible = false;
            // Add the chunk of time spent before hiding
            const now = Date.now();
            const delta = Math.floor((now - startTime) / 1000);
            if (delta > 0) {
                window.quizElapsedSeconds += delta;
            }
            console.log("Quiz Paused. Added:", delta, "Total:", window.quizElapsedSeconds);
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        // --- TIMER LOGIC ---
        const quizTimeLimit = {{ quiz_time_limit | default (5)
    }};
    let timeLeft = quizTimeLimit * 60;
    const timerDisplay = document.getElementById('timer');
    const quizForm = document.getElementById('quiz-form');

    // Display Update Loop (Visual Only - syncs every second)
    setInterval(() => {
        if (document.visibilityState === 'visible') {
            // Calculate potential total if we stopped right now
            const currentSession = Math.floor((Date.now() - startTime) / 1000);
            const totalDisplay = window.quizElapsedSeconds + currentSession;
            // console.log("Current Display Time:", totalDisplay);
        }
    }, 1000);

    if (quizTimeLimit > 0) {
        // Initial display
        updateTimerDisplay(timeLeft);

        const countdown = setInterval(() => {
            timeLeft--;
            updateTimerDisplay(timeLeft);

            if (timeLeft <= 0) {
                clearInterval(countdown);
                alert("Time is up! Submitting your quiz.");
                quizForm.submit();
            }
        }, 1000);

        // Expose timers to be cleared on submit
        window.quizTimers = { countdown };
    } else {
        window.quizTimers = {};
    }

    // Expose elapsedSeconds for submission handler
    window.getElapsedSeconds = () => elapsedSeconds;

    function updateTimerDisplay(secondsLeft) {
        const minutes = Math.floor(secondsLeft / 60);
        const seconds = secondsLeft % 60;
        if (timerDisplay) timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }
    });

    // Prevent double submission & Inject Quiz Time
    document.getElementById('quiz-form').onsubmit = function () {
        const form = this;
        const btn = form.querySelector('button[type="submit"]');

        // 1. Show Overlay
        const overlay = document.getElementById('gradingOverlay');
        const statusText = document.getElementById('gradingStatus');
        if (overlay) overlay.style.display = 'flex';

        // 2. Disable interaction (Visual only, to ensure data is sent)
        const allInputs = form.querySelectorAll('input, select, textarea, button');
        allInputs.forEach(input => {
            // DO NOT set disabled=true, otherwise data won't be sent!
            if (input.type !== 'hidden') {
                input.setAttribute('readonly', 'readonly'); // For text inputs
                input.style.pointerEvents = 'none'; // Prevent clicks for selects/radios
                input.style.opacity = '0.6'; // Visual cue
            }
            if (input.tagName === 'BUTTON') {
                input.disabled = true; // Buttons can be disabled safely
            }
        });

        // 3. Dynamic Status Updates
        const messages = [
            "Uploading answers...",
            "Analyzing performance...",
            "Calculating score...",
            "Generating feedback...",
            "Almost there..."
        ];
        let msgIdx = 0;

        // Change message every 1.5 seconds
        setInterval(() => {
            if (msgIdx < messages.length) {
                if (statusText) statusText.textContent = messages[msgIdx];
                msgIdx++;
            }
        }, 1500);

        // Stop tracking elapsed time
        // Timestamp logic doesn't need interval clearing, just final calculation.

        // Inject Quiz Duration (use actual elapsed time)
        try {
            // Finalize Time Calculation (Add pending active session)
            if (document.visibilityState === 'visible') {
                const now = Date.now();
                const delta = Math.floor((now - startTime) / 1000);
                if (delta > 0) window.quizElapsedSeconds += delta;
            }

            let st = JSON.parse(document.getElementById('stageTimingInput').value || "{}");
            // Use the global variable
            st["Quiz"] = window.quizElapsedSeconds || 0;
            console.log("FINAL SUBMISSION TIME:", st["Quiz"]);

            document.getElementById('stageTimingInput').value = JSON.stringify(st);

            // Clear LocalStorage
            localStorage.removeItem(storageKey);
            localStorage.removeItem(stageStorageKey);
            console.log("LocalStorage cleared for course:", {{ course_id }});
    } catch (e) { console.error(e); }

    // Form submits naturally
    return true;
    };

    // --- DYNAMIC QUIZ RENDERER ---
    // --- DYNAMIC QUIZ RENDERER ---
    const rawConfig = {{ quiz_config | tojson | safe }};
    let QUIZ_DATA = [];
    try {
        // If it's already an object, use it. If string, parse it.
        QUIZ_DATA = (typeof rawConfig === 'string') ? JSON.parse(rawConfig || '[]') : rawConfig;
    } catch (e) { console.error("Invalid Quiz Config", e); }

    if (QUIZ_DATA.length > 0) {
        document.getElementById('legacyQuiz').innerHTML = ''; // Remove legacy DOM to avoid validation conflicts
        document.getElementById('dynamicQuiz').style.display = 'block';
        renderDynamicQuiz(QUIZ_DATA);
    }

    function renderDynamicQuiz(data) {
        const container = document.getElementById('dynamicQuiz');
        let html = '';

        data.forEach((block, idx) => {
            if (block.block_type === 'title') {
                html += `
                <div class="card p-4 mb-3 shadow-sm" style="border-top: 5px solid #673ab7;">
                    <h2>${block.title || ''}</h2>
                    <p class="text-muted">${block.description || ''}</p>
                </div>`;
            } else if (block.block_type === 'image') {
                const imageId = `dynamic-img-${idx}`;
                html += `
                <div class="card p-3 mb-3 shadow-sm text-center">
                    ${block.title ? `<h5 class="mb-2">${block.title}</h5>` : ''}
                    ${block.image_url ? `
                        <div class="image-container d-inline-block">
                            <img src="${block.image_url}" 
                                class="img-fluid rounded" 
                                style="max-height:400px; width: auto; object-fit: contain; margin: 0 auto; display: block;"
                                onload="trackImageView('${block.image_url}', {{ course_id }}, null)">
                        </div>
                    ` : ''}
                </div>`;
            } else if (block.block_type === 'video') {
                let embed = block.video_url || "";
                if (embed.includes("watch?v=")) embed = embed.replace("watch?v=", "embed/");
                if (embed.includes("youtu.be")) embed = "https://www.youtube.com/embed/" + embed.split("/").pop();

                html += `
                <div class="card p-3 mb-3 shadow-sm">
                    ${block.title ? `<h5 class="mb-2">${block.title}</h5>` : ''}
                    <div class="ratio ratio-16x9">
                        <iframe src="${embed}" allowfullscreen></iframe>
                    </div>
                </div>`;
            } else if (block.block_type === 'section') {
                html += `
                <div class="alert alert-secondary mt-4 mb-3 border-left-primary">
                    <h4>${block.title || 'Section'}</h4>
                    ${block.description ? `<p>${block.description}</p>` : ''}
                </div>`;
            } else if (block.block_type === 'question') {
                html += renderQuestion(block, idx);
            }
        });

        container.innerHTML = html;
    }

    function renderQuestion(q, idx) {
        let h = `
        <div class="card p-4 mb-3 shadow-sm">
            ${q.title ? `<h5 class="mb-3">${q.title} ${q.required ? '<span class="text-danger">*</span>' : ''}</h5>` : ''}
            ${q.image_url ? `
                <div class="image-container d-inline-block mb-3">
                    <img src="${q.image_url}" 
                        class="img-fluid rounded" 
                        style="max-height:300px; width: auto; object-fit: contain; margin: 0 auto; display: block;"
                        onload="trackImageView('${q.image_url}', {{ course_id }}, null)">
                </div>
            ` : ''}
        `;

        const qName = `q_${q.id || idx}`;
        const reqAttr = q.required ? 'required' : '';

        if (q.type === 'short_answer') {
            h += `<input type="text" class="form-control" name="${qName}" placeholder="Your answer" ${reqAttr}>`;
        } else if (q.type === 'paragraph' || q.type === 'sentence') {
            h += `<textarea class="form-control" name="${qName}" rows="3" placeholder="Your answer" ${reqAttr}></textarea>`;
        } else if (q.type === 'date') {
            h += `<input type="date" class="form-control" name="${qName}" ${reqAttr}>`;
        } else if (q.type === 'time') {
            h += `<input type="time" class="form-control" name="${qName}" ${reqAttr}>`;
        } else if (q.type === 'multiple_choice') {
            (q.options || []).forEach(opt => {
                h += `
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="${qName}" value="${opt}" ${reqAttr}>
                    <label class="form-check-label">${opt}</label>
                </div>`;
            });
        } else if (q.type === 'checkboxes') {
            // Checkboxes: name should be array-like usually, but simple form post might need handling.
            // Be careful with 'required' on checkboxes (needs at least one). 
            // Browser native 'required' on checkbox group is tricky.
            // For now, let's omit 'required' enforcement on checkboxes to avoid blocking submission if logic is complex,
            // or use simple JS validation later.
            (q.options || []).forEach(opt => {
                h += `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="${qName}" value="${opt}">
                    <label class="form-check-label">${opt}</label>
                </div>`;
            });
        } else if (q.type === 'dropdown') {
            h += `<select class="form-select" name="${qName}" ${reqAttr}>
                    <option value="" selected disabled>Choose...</option>`;
            (q.options || []).forEach(opt => {
                h += `<option value="${opt}">${opt}</option>`;
            });
            h += `</select>`;
        }

        h += `</div>`;
        return h;
    }


    function trackImageView(imageUrl, courseId, vocabId) {
        const formData = new FormData();
        formData.append('image_url', imageUrl);
        formData.append('action', 'view');
        formData.append('course_id', courseId);
        formData.append('vocab_id', vocabId || '');
        formData.append('context', 'quiz');

        fetch('/api/image_interaction', { method: 'POST', body: formData }).catch(e => console.error('View tracking failed', e));
    }
</script>
{% endblock %}